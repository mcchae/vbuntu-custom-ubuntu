# 목적

애초에 만들기 위한 목적 및 설치 등에 관해서는 [해당 내용]()을 참고하시기 바랍니다. 여기서는 우분투 서버 ISO 위에 필요한 정보를 만들어 커스텀화 하고 설치 시 자동으로 설정을 지정하여 사용자 관여는 처음 한번만 하도록 수정한 것 등에 관해서 설명을 하려고 합니다.

우선 커스텀 CD를 만들기 시작했던 것은 우분투서버 12.04에서 시작했었던 것 같습니다.

> [[우분투] 12.04 커스텀 ISO 서버 이미지 만들어 보기](http://mcchae.egloos.com/11145086)

그 이후 퓨쳐시스템에 있으면서 관련 작업을 진전시키다가 이번에 시간을 내어 GitHub 공개를 하였습니다. (누구든지 가져다가 필요한 것을 커스터마이즈 하시기 바랍니다)

## 테스트 완료 이미지

다음과 같은 우분투 서버 이미지로 부터 출발하여 이미지를 만들었습니다. 우선 해당 버전 위주로 작성을 해 보시고 안되면 연락 주시기 바랍니다. ([이메일 연락처](mailto:mcchae@gmail.com))


* [VbuntuServer-12.04.5-amd64.iso](https://drive.google.com/open?id=0ByDuZ7fltXXhSUhENFI4eHpBZjQ) : 우분투 서버 12.04.5 64bit 버전을 기반으로 만들어 놓은 것입니다.
* [VbuntuServer-14.04.5-amd64.iso](https://drive.google.com/open?id=0ByDuZ7fltXXhYVNPRXdIVDByNWc) : 우분투 서버 14.04.5 64bit 버전을 기반으로 만들어 놓은 것입니다.
* [VbuntuServer-16.04-amd64.iso](https://drive.google.com/open?id=0ByDuZ7fltXXhVDlpVldjbW05dkk) : 우분투 서버 16.04 64bit 버전을 기반으로 만들어 놓은 것입니다.


## 커스텀 ISO 생성 방법

### 우분투 서버 설치

우선 가상머신에 다음 중에 하나를 설치합니다.

* [우분투 12.04.5](http://ftp.daumkakao.com/ubuntu-releases/precise/ubuntu-12.04.5-server-amd64.iso)
* [우분투 14.04.5](http://ftp.daumkakao.com/ubuntu-releases/trusty/ubuntu-14.04.5-server-amd64.iso)
* [우분투 16.04](http://old-releases.ubuntu.com/releases/16.04.0/ubuntu-16.04-server-amd64.iso)

> 혹시 해당 링크가 이상하다면 [이전버전 우분투](http://old-releases.ubuntu.com/releases/) 에서 찾으시기 바랍니다.

> `최소가상머신(JEOS) 설치로 해도 될 것 같은데, 일반 설치로 테스트 하였습니다


### build 환경 준비

``` sh
$ git clone https://github.com/mcchae/vbuntu-custom-ubuntu.git
$ cd vbuntu-custom-ubuntu
```

### build
``` sh
$ ./build.sh
```
성공적으로 build가 완성되면 해당 폴더에 `VbuntuServer-16.04-amd64.iso`와 같은 결과 iso 이미지가 만들어질 것입니다.

## 사용자화

### 자동 설치 관련

``` sh
$ cd custom/
$ ls -l ks_dhcp*
-rw-rw-r--  1 moonchangchae  staff   1.0K  7 17 10:03 ks_dhcp.12.04.5.cfg
-rw-r--r--  1 moonchangchae  staff   1.6K  7 14 10:50 ks_dhcp.14.04.5.cfg
lrwxr-xr-x  1 moonchangchae  staff    17B  7 17 14:37 ks_dhcp.16.04.2.cfg@ -> ks_dhcp.16.04.cfg
-rw-r--r--  1 moonchangchae  staff   1.6K  7 14 10:49 ks_dhcp.16.04.cfg
```

 위에 있는 것과 같은 것은 kicstart 에서 돌린 결과의 설정파일이며 다음과 같은 형식 입니다.
 
``` sh 
$ cat ks_dhcp.16.04.cfg
#Generated by Kickstart Configurator
#platform=AMD64 or Intel EM64T

#System language
lang ko_KR
#Language modules to install
langsupport en_US --default=ko_KR
#System keyboard
keyboard kr_kr104
#System mouse
mouse
#System timezone
timezone Asia/Seoul
#Root password
rootpw --disabled
#Initial user
user toor --fullname "toor System User" --iscrypted --password $1$fG6SJ5YT$lJEiSxwAHSnlzaUUDF57b0
#Reboot after installation
reboot
#Use text mode install
text
#Install OS instead of upgrade
install
#Use CDROM installation media
cdrom
#System bootloader configuration
bootloader --location=mbr 

#Clear the Master Boot Record
zerombr yes
#Partition clearing information
clearpart --all --initlabel
#Disk partitioning information
part /boot --fstype ext4 --size=500
#part swap --size=1024
part swap --recommended 
#part pv.01      --size=1000     --grow  --ondisk=sda
part pv.01 --size=1 --grow
volgroup vg00 pv.01
logvol / --vgname=vg00  --fstype=ext4  --size=1 --grow --name=lv_root
#logvol /var --vgname=vg00 --fstype=ext4 --size=2048 --name=lv_var
logvol /tmp --vgname=vg00 --fstype=ext4 --size=2048 --name=lv_tmp

##Clear the Master Boot Record
#zerombr yes
##Partition clearing information
#clearpart --all --initlabel 
##Disk partitioning information
#part / --fstype ext4 --size 1 --grow 
#part swap --recommended 


#System authorization infomation
auth  --useshadow  --enablemd5 
#Network information
network --bootproto=dhcp --device=eth0
#Firewall configuration
firewall --disabled --trust=eth0 --http --ssh 
#Do not configure the X Window System
skipx
%pre
#/opt/VbuntuServer/preinstall.sh
%post
#/opt/VbuntuServer/postinstall.sh

```

> 주의: ks_dhcp.16.04.cfg 에서 `16.04` 대신 자신의 해당 버전을 확인하시기 바랍니다.

대부분 직관적인 유추를 할 수 있을 것입니다.

사용자는 `toor` 에 암호는 `r`로 설정했습니다.
또한 로지컬 볼륨으로 전체 디스크를 잡아 사용합니다. DHCP client로 IP를 받아옵니다.
방화벽 설정은 하지 않았습니다.

[kickstart](https://en.wikipedia.org/wiki/Kickstart_(Linux))를 이용한 자동화 설치 방법을 이용하였는데 더 좋은 방법이 있을 것 같기도 합니다. (아시는 분을 아려주십시오)

### 설치 패키지 관련

``` sh
$ cd custom
$ ls -l pkgs*
lrwxr-xr-x  1 moonchangchae  staff     8B  4 26  2016 pkgs.12.04.5.cfg@ -> pkgs.cfg
lrwxr-xr-x  1 moonchangchae  staff     8B  4 26  2016 pkgs.14.04.5.cfg@ -> pkgs.cfg
lrwxr-xr-x  1 moonchangchae  staff    14B  7 14 10:30 pkgs.16.04.2.cfg@ -> pkgs.16.04.cfg
-rw-r--r--  1 moonchangchae  staff   1.3K  7 14 15:53 pkgs.16.04.cfg
-rw-rw-r--  1 moonchangchae  staff   997B  7 14 10:11 pkgs.cfg
```

``` sh
$ cat pkgs.16.04.cfg
###############################################################################
#Package install information
###############################################################################
%packages
openssh-server
build-essential
# bash tab 확장이 빠져있음
bash-completion
###############################################################################
# for LXDE
xrdp 
# lxde => lxde-core for 16.04
galculator
gpicview
leafpad
lxappearance
lxappearance-obconf
lxde-core
lxde-icon-theme
lxinput
lxrandr
lxsession-edit
lxterminal
lxde-common
xarchiver
evince-gtk
lxshortcut
openbox
xserver-xorg
apt-transport-https

lxdm 
fonts-nanum 
fonts-nanum-coding 
nabi
# im-switch => im-config
im-config 
zenity
firefox
#systemd-shim # does not exist in 12.04 ###############################################################################
# for DHCP
isc-dhcp-client
###############################################################################
# for development
subversion
###############################################################################
# for util
vim
gdebi
lvm2
tmux
###############################################################################
# for python
python-dev
python-pip
# Ubuntu 16.04 does not contain lxsession-logout
lxsession-logout
###############################################################################
# for vbuntupkg
vbuntupkg

```

> 주의: pkgs.16.04.cfg 에서 `16.04` 대신 자신의 해당 버전을 확인하시기 바랍니다.

위의 패키지 내용은 각각 다음의 내용을 기본으로 설정하였습니다.

* [[Ubuntu 12.04/14.04] 가벼운 LXDE 환경](http://mcchae.egloos.com/10991779)
* [[Ubuntu 16.04] 가벼운 LXDE 환경](http://mcchae.egloos.com/11214796)

각각 필요한 내용이 있으시면 위에 패키지를 추가하시면 됩니다.

### vbuntupkg

`toor` 사용자 관련 쉘 환경, 윈도우 환경 등을 처리하는 패키지 입니다. 
build 하는 과정은 `build.sh` 에서 `00_vbuntupkg.sh` 를 우선 실행시키는데 이 쉘에서 vbuntupkg 폴더 안에 있는 내용을 실행시킵니다.

해당 패키지가 실행되는 기본과정은 다음과 같습니다.

1. 패키지가 복사하도록 되어 있는 /etc, /home/toor, /opt/VbuntuServer 등에 필요파일을 복사합니다.
2. /opt/VbuntuServer/postinstall.sh 가 실행됩니다.


# 결론

위의 작업을 약간 수정하여 자신만의 시스템을 우분투 서버 위에 꾸밀 수 있을 것입니다.

많은 필요하셨던 분들께 도움이 되셨기를 바랍니다.
